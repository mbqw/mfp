<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欢迎</title>
    <th:block th:replace="/common::css2">
    </th:block>
    <style>
        p{
            word-wrap: break-word;
            word-break: break-all;
            overflow: hidden;
        }
        body {
            background-color: #F2F3F4;
        }
    </style>
</head>
<body>
<input type="hidden" id="user_id" th:value="${user.id}">
<!--菜单-->
<div class="content-menu">
    <ul>
        <li onclick="addMsg()">发布</li>
        <li onclick="userStars()">收藏</li>
        <li onclick="userIM()">好友</li>
        <li onclick="location.reload(true);">主页</li>
        <li th:onclick="|toDetail(${user.id})|">个人</li>
    </ul>
</div>
<!--内容-->
<div id="container" style="top: 20px;"></div>

<!-- 模板 -->
<script id="role" type="text/html">
    {{each list as value}}
     <ul class="item list-group">
        <li class="list-group-item" id="view{{value.id}}">
            {{each value.img as index i}}
            {{if i==0}}
            <img class="cd-trigger" onclick="viewPhoto('{{value.id}}')" src="{{index}}" layer-src="{{index}}"/>
            {{else}}
            <img src="{{index}}" layer-src="{{index}}" style="display: none"/>
            {{/if}}
            {{/each}}
        </li>
        <li class="list-group-item">
            <button id="like{{value.id}}" onclick="msg_like('{{value.id}}')" type="button" class="btn btn-default btn-xs" title="{{value.ylike}}"><span class="glyphicon glyphicon-thumbs-up"></span></button>
            <button id="unlike{{value.id}}" onclick="msg_unlike('{{value.id}}')" type="button" class="btn btn-default btn-xs" title="{{value.unlike}}"><span class="glyphicon glyphicon-thumbs-down"></span></button>
            <span style="margin-left: 30px">1/{{value.img.length}}</span>
            <button id="comment{{value.id}}" onclick="msg_comment('{{value.id}}')" type="button" class="btn btn-default btn-xs pull-right" title="评论" style="margin-left: 4px"><span class="glyphicon glyphicon-comment"></span></button>
            <button id="star{{value.id}}" onclick="msg_star('{{value.id}}',this)" type="button" class="btn btn-default btn-xs pull-right" title="{{value.star}}" >
                {{if value.starId != null}}
                <span class="glyphicon glyphicon-star"></span></button>
            {{else}}
            <span class="glyphicon glyphicon-star-empty"></span>
            {{/if}}
            </button>

        </li>
        <li class="list-group-item">
            <div class="media">
                <div class="media-left">
                    <img onclick="toDetail('{{value.u_id}}')" class="media-object img-rounded cd-trigger avatar{{value.u_id}}" style="width: 30px; height: 30px;border-radius:30px;"  src="{{value.user.avatar}}" />
                </div>
                <div class="media-body">
                    <input type="hidden" id="id" value="{{value}}"/>
                    <h5 class="media-heading username{{value.u_id}}">{{value.user.username}}</h5>
                    {{if value.content.length<100}}
                    <p id="msg_p" style="font-size: small">
                        {{#value.content}}
                    </p>
                    {{else}}
                    <p style="font-size: small">
                        {{#value.content}}
                    </p>
                    <br>
                    <a id="msg_a" onclick="moreContent('{{value.id}}')" href="javascript:void(0)" class="msg_a">更多...</a>
                    {{/if}}
                </div>
            </div>
        </li>
    </ul>
    {{/each}}
</script>
<th:block th:replace="/common::js2"></th:block>
<script>
    $('#container').waterfall({
        itemCls: 'item',
        fitWidth:false,
        colWidth: 222,
        gutterWidth: 15,
        gutterHeight: 15,
        maxCol:5,
        checkImagesLoaded: false,
        resizable:true,
        isAnimated:true,
        dataType: 'json',
        path: function(page) {
            return '/platform/getData?page='+page;
        },
        params:{
            queryParams:{
                user_id:$("#user_id").val()
            }
        },
        callbacks: {
            loadingStart: function($loading) {
                $loading.show();
                //console.log('loading', 'start');
            },
            loadingFinished: function($loading, isBeyondMaxPage) {
                if ( !isBeyondMaxPage ) {
                    $loading.fadeOut();
                    //console.log('loading finished');
                } else {
                    //console.log('loading isBeyondMaxPage');
                    $loading.remove();
                }
            },
            loadingError: function($message, xhr) {
                $message.html('加载失败,请稍后重试');
            },
            /*
            * 处理ajax返回数方法
            * @param {String} data
            */
            renderData: function (data) {
                if (data.success) {
                    var htmlData = {
                        list:data.rows
                    };
                    var html = template('role', htmlData);
                    return html;
                }else{
                    $('#container').waterfall('pause', function() {
                        $('#waterfall-message').html("<br><br><br><p style='color:#666;'>"+data.info+"</p>")
                        //alert('no more data');
                    });
                }

            }
        },
    });

</script>
<script>
    var layim;
    layui.use('layim', function(){
        layim = layui.layim;
        //基础配置
        layim.config({
            //初始化接口
            init: {
                url: '/im/init'
                ,data: {
                    id:document.getElementById("user_id").value,
                }
            }
            //查看群员接口
            ,members: {
                url: '/getMembers.json'
                ,data: {}
            }

            ,uploadImage: {
                url: '' //（返回的数据格式见下文）
                ,type: '' //默认post
            }
            ,uploadFile: {
                url: '' //（返回的数据格式见下文）
                ,type: '' //默认post
            }
            //扩展工具栏
            /*,tool: [{
                alias: 'code'
                ,title: '代码'
                ,icon: '&#xe64e;'
            }]*/
            ,title: '开始聊天' //自定义主面板最小化时的标题
            ,initSkin: '3.jpg' //1-5 设置初始背景
            ,notice: true //是否开启桌面消息提醒，默认false
            ,min:true //用于设定主面板是否在页面打开时，始终最小化展现
            ,isAudio:true //开启聊天工具栏音频
            ,isVideo:true //开启聊天工具栏视频
            ,msgbox: '/layui/css/modules/layim/html/msgbox.html' //消息盒子页面地址，若不开启，剔除该项即可
            ,find: '/layui/css/modules/layim/html/find.html' //发现页面地址，若不开启，剔除该项即可
            ,chatLog: '/layui/css/modules/layim/html/chatlog.html' //聊天记录页面地址，若不开启，剔除该项即可
            /*,copyright:true*/
        });
        layim.on('sendMessage', function(data) {
            var mine = data.mine; //包含我发送的消息及我的信息
            socket.send(JSON.stringify({
                type:{
                    type:data.to.type
                },
                mine:data.mine,
                to:data.to
            }));
        })
        $('.site-demo-layim').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
<script th:inline="javascript">

    //连接成功时触发
    var userid = [[${user.id}]];
    var username = [[${user.username}]];
    var useravatar = [[${user.avatar}]];
    var socket = new WebSocket('ws://' + window.location.host + '/websocket/'+userid);
    socket.onopen = function(){

    };

    //监听收到的消息
    socket.onmessage = function(res){
        console.info(res);
        res = JSON.parse(res.data);
        if(res.emit === 'friend'||res.emit === 'group'){
            layim.getMessage(res.data); //res.data即你发送消息传递的数据（阅读：监听发送的消息）
        }
    };
    //添加好友
    function addFriend(descUserId) {
        layim.add({
            type: 'friend'
            ,username: username
            ,avatar: useravatar
            ,submit: function(group, remark, index){
                socket.send(JSON.stringify({
                    type: {
                        type:'addFriend'
                    }
                    ,data: {
                        msg:group,
                        reark:remark
                    }
                }));
                layer.msg('好友申请已发送，请等待对方确认', {
                    icon: 1
                    ,shade: 0.5
                }, function(){
                    layer.close(index);
                });
            }
        });
    }
    function setFriendGroup(descUserId) {
        layim.setFriendGroup({
            type: 'friend'
            ,username: 'xxx' //好友昵称，若申请加群，参数为：groupname
            ,avatar: 'a.jpg' //头像
            ,group: layim.cache().friend //获取好友列表数据
            ,submit: function(group, index){
                //一般在此执行Ajax和WS，以通知对方已经同意申请
                //……

                //同意后，将好友追加到主面板
                layim.addList(data); //见下文
            }
        });
    }
</script>
</body>
</html>